(function(){"use strict";var e={7814:function(e,s,t){var r=t(5130),o=t(6768);function n(e,s,t,r,n,a){const i=(0,o.g2)("router-view");return(0,o.uX)(),(0,o.Wv)(i)}var a={name:"RegistrationPage"},i=t(1241);const c=(0,i.A)(a,[["render",n]]);var l=c,d=t(973),u=t(4232);const h={class:"reg-wrapper"},g={class:"form-container"},m={key:0,class:"error-message"},k={key:1,class:"error-message"},p={key:2,class:"error-message"},f={key:3,class:"error-message general-error"},v={key:4,class:"success-message"};function E(e,s,t,n,a,i){const c=(0,o.g2)("router-link");return(0,o.uX)(),(0,o.CE)("div",h,[(0,o.Lk)("div",g,[s[8]||(s[8]=(0,o.Lk)("label",{class:"label"},"Login",-1)),(0,o.bo)((0,o.Lk)("input",{type:"text",class:"input","onUpdate:modelValue":s[0]||(s[0]=e=>a.nickname=e),onInput:s[1]||(s[1]=e=>i.clearErrors("nickname"))},null,544),[[r.Jo,a.nickname]]),a.nicknameError?((0,o.uX)(),(0,o.CE)("div",m,(0,u.v_)(a.nicknameError),1)):(0,o.Q3)("",!0),s[9]||(s[9]=(0,o.Lk)("label",{class:"label"},"Password",-1)),(0,o.bo)((0,o.Lk)("input",{type:"password",class:"input","onUpdate:modelValue":s[2]||(s[2]=e=>a.password=e),onInput:s[3]||(s[3]=e=>i.clearErrors("password"))},null,544),[[r.Jo,a.password]]),a.passwordError?((0,o.uX)(),(0,o.CE)("div",k,(0,u.v_)(a.passwordError),1)):(0,o.Q3)("",!0),s[10]||(s[10]=(0,o.Lk)("label",{class:"label"},"Password Check",-1)),(0,o.bo)((0,o.Lk)("input",{type:"password",class:"input","onUpdate:modelValue":s[4]||(s[4]=e=>a.confirmPassword=e),onInput:s[5]||(s[5]=e=>i.clearErrors("confirmPassword"))},null,544),[[r.Jo,a.confirmPassword]]),a.confirmPasswordError?((0,o.uX)(),(0,o.CE)("div",p,(0,u.v_)(a.confirmPasswordError),1)):(0,o.Q3)("",!0),a.generalError?((0,o.uX)(),(0,o.CE)("div",f,(0,u.v_)(a.generalError),1)):(0,o.Q3)("",!0),a.successMessage?((0,o.uX)(),(0,o.CE)("div",v,(0,u.v_)(a.successMessage),1)):(0,o.Q3)("",!0),(0,o.Lk)("button",{class:"btn",onClick:s[6]||(s[6]=(...e)=>i.register&&i.register(...e))},"Registration"),(0,o.bF)(c,{to:"/log",class:"link"},{default:(0,o.k6)((()=>s[7]||(s[7]=[(0,o.eW)("Already have an account?")]))),_:1,__:[7]})])])}t(4114);function w(e){const s=/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;return e?e.length<8?"Пароль должен содержать минимум 8 символов.":s.test(e)?"":"Пароль должен содержать хотя бы одну заглавную букву, одну строчную букву и одну цифру.":"Пароль не может быть пустым."}function y(e,s){return s?e!==s?"Пароли не совпадают.":"":"Подтверждение пароля не может быть пустым."}var I={name:"RegistrationPage",data(){return{nickname:"",password:"",confirmPassword:"",nicknameError:"",passwordError:"",confirmPasswordError:"",generalError:"",successMessage:""}},methods:{clearErrors(e=null){"nickname"===e?this.nicknameError="":"password"===e?this.passwordError="":"confirmPassword"===e?this.confirmPasswordError="":(this.nicknameError="",this.passwordError="",this.confirmPasswordError="",this.generalError="",this.successMessage="")},async register(){this.clearErrors();let e=!0;this.nickname.trim()||(this.nicknameError="Логин не может быть пустым.",e=!1);const s=w(this.password);s&&(this.passwordError=s,e=!1);const t=y(this.password,this.confirmPassword);if(t&&(this.confirmPasswordError=t,e=!1),e)try{const e=await fetch("http://192.168.100.2:3000/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname:this.nickname,password:this.password})}),s=await e.json();e.ok?(this.successMessage=s.message||"Регистрация успешно выполнена!",this.nickname="",this.password="",this.confirmPassword="",setTimeout((()=>{this.$router.push("/log")}),2e3)):this.generalError=s.message||"Произошла ошибка при регистрации. Пожалуйста, попробуйте еще раз."}catch(r){this.generalError="Не удалось подключиться к серверу. Проверьте ваше интернет-соединение или запустите сервер."}}}};const M=(0,i.A)(I,[["render",E],["__scopeId","data-v-75c65300"]]);var b=M;const C={class:"login-wrapper"},x={class:"form-container"},_={key:0,class:"error-message"},T={key:1,class:"error-message"},L={key:2,class:"error-message general-error"},S={key:3,class:"success-message"};function U(e,s,t,n,a,i){const c=(0,o.g2)("router-link");return(0,o.uX)(),(0,o.CE)("div",C,[(0,o.Lk)("div",x,[s[6]||(s[6]=(0,o.Lk)("label",{class:"label"},"Login",-1)),(0,o.bo)((0,o.Lk)("input",{type:"text",class:"input","onUpdate:modelValue":s[0]||(s[0]=e=>a.nickname=e),onInput:s[1]||(s[1]=e=>i.clearErrors("nickname"))},null,544),[[r.Jo,a.nickname]]),a.nicknameError?((0,o.uX)(),(0,o.CE)("div",_,(0,u.v_)(a.nicknameError),1)):(0,o.Q3)("",!0),s[7]||(s[7]=(0,o.Lk)("label",{class:"label"},"Password",-1)),(0,o.bo)((0,o.Lk)("input",{type:"password",class:"input","onUpdate:modelValue":s[2]||(s[2]=e=>a.password=e),onInput:s[3]||(s[3]=e=>i.clearErrors("password"))},null,544),[[r.Jo,a.password]]),a.passwordError?((0,o.uX)(),(0,o.CE)("div",T,(0,u.v_)(a.passwordError),1)):(0,o.Q3)("",!0),a.generalError?((0,o.uX)(),(0,o.CE)("div",L,(0,u.v_)(a.generalError),1)):(0,o.Q3)("",!0),a.successMessage?((0,o.uX)(),(0,o.CE)("div",S,(0,u.v_)(a.successMessage),1)):(0,o.Q3)("",!0),(0,o.Lk)("button",{class:"btn",onClick:s[4]||(s[4]=(...e)=>i.login&&i.login(...e))},"Login"),(0,o.bF)(c,{to:"/",class:"link"},{default:(0,o.k6)((()=>s[5]||(s[5]=[(0,o.eW)("Don't have an account?")]))),_:1,__:[5]})])])}function P(e){return e&&""!==e.trim()?e.length<3?"Логин должен быть не менее 3 символов.":"":"Логин не может быть пустым."}function X(e){return e&&""!==e.trim()?"":"Пароль не может быть пустым."}var $={name:"LoginPage",data(){return{nickname:"",password:"",nicknameError:"",passwordError:"",generalError:"",successMessage:""}},methods:{clearErrors(e=null){"nickname"===e?this.nicknameError="":"password"===e?this.passwordError="":(this.nicknameError="",this.passwordError="",this.generalError="",this.successMessage="")},async login(){this.clearErrors();let e=!0;const s=P(this.nickname);s&&(this.nicknameError=s,e=!1);const t=X(this.password);if(t&&(this.passwordError=t,e=!1),e)try{const e=await fetch("http://192.168.100.2:3000/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname:this.nickname,password:this.password})}),s=await e.json();e.ok?(this.successMessage=s.message||"Вход успешно выполнен!",localStorage.setItem("chatToken",s.token),localStorage.setItem("chatUserId",s.userId),localStorage.setItem("chatNickname",s.nickname),this.nickname="",this.password="",setTimeout((()=>{this.$router.push("/chat")}),1500)):this.generalError=s.message||"Произошла ошибка при входе. Пожалуйста, попробуйте еще раз."}catch(r){this.generalError="Не удалось подключиться к серверу. Проверьте ваше интернет-соединение или запустите сервер."}}}};const j=(0,i.A)($,[["render",U],["__scopeId","data-v-0837c904"]]);var O=j;const D={class:"chat-container"},N={class:"user-list-sidebar"},Q={class:"user-list"},A={key:0,class:"loading-users"},B={key:1},J=["onClick"],F={class:"main-chat-area"},R={class:"chat-header"},V={class:"messages",ref:"messagesContainer"},K={key:0,class:"no-chat-selected"},z={key:0,class:"timestamp"},W=["onClick","onContextmenu"],H={class:"edit-actions"},Y=["onClick"],Z=["onClick"],q={class:"input-area"},G={class:"input-wrapper"},ee=["disabled"],se=["disabled"];function te(e,s,t,n,a,i){const c=(0,o.gN)("focus");return(0,o.uX)(),(0,o.CE)("div",D,[(0,o.Lk)("div",N,[s[8]||(s[8]=(0,o.Lk)("div",{class:"sidebar-header"},[(0,o.Lk)("h3",null,"Chat Name")],-1)),(0,o.Lk)("div",Q,[0===a.users.length?((0,o.uX)(),(0,o.CE)("div",A," Загрузка пользователей... ")):((0,o.uX)(),(0,o.CE)("ul",B,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(a.users,(e=>((0,o.uX)(),(0,o.CE)("li",{key:e.id,onClick:s=>i.selectUser(e),class:(0,u.C4)({"selected-user":a.selectedUser&&a.selectedUser.id===e.id})},(0,u.v_)(e.nickname)+" "+(0,u.v_)(e.id===a.userId?"(Вы)":""),11,J)))),128))]))])]),(0,o.Lk)("div",F,[(0,o.Lk)("div",R,[(0,o.Lk)("h2",null,(0,u.v_)(a.selectedUser?a.selectedUser.nickname:"Выберите собеседника"),1)]),(0,o.Lk)("div",V,[a.selectedUser?((0,o.uX)(!0),(0,o.CE)(o.FK,{key:1},(0,o.pI)(a.messages,((e,t)=>((0,o.uX)(),(0,o.CE)("div",{key:e.id,class:"message-group"},[i.shouldShowTimestamp(e.timestamp,t>0?a.messages[t-1].timestamp:null)?((0,o.uX)(),(0,o.CE)("div",z,(0,u.v_)(i.formatTimestamp(e.timestamp)),1)):(0,o.Q3)("",!0),(0,o.Lk)("div",{class:(0,u.C4)(["message",e.sender_id===a.userId?"message--sent":"message--received"]),onClick:s=>e.sender_id===a.userId&&i.showContextMenu(e,s),onContextmenu:(0,r.D$)((s=>e.sender_id===a.userId&&i.showContextMenu(e,s)),["prevent"])},[a.editingMessageId===e.id?((0,o.uX)(),(0,o.CE)(o.FK,{key:0},[(0,o.bo)((0,o.Lk)("input",{"onUpdate:modelValue":s[0]||(s[0]=e=>a.editingMessageText=e),onKeyup:[s[1]||(s[1]=(0,r.jR)(((...e)=>i.saveEditedMessage&&i.saveEditedMessage(...e)),["enter"])),s[2]||(s[2]=(0,r.jR)(((...e)=>i.cancelEditing&&i.cancelEditing(...e)),["esc"]))],class:"edit-input"},null,544),[[r.Jo,a.editingMessageText],[c]]),(0,o.Lk)("div",H,[(0,o.Lk)("button",{onClick:s[3]||(s[3]=(...e)=>i.saveEditedMessage&&i.saveEditedMessage(...e)),class:"save-button"},"Сохранить"),(0,o.Lk)("button",{onClick:s[4]||(s[4]=(...e)=>i.cancelEditing&&i.cancelEditing(...e)),class:"cancel-button"},"Отмена")])],64)):((0,o.uX)(),(0,o.CE)(o.FK,{key:1},[(0,o.eW)((0,u.v_)(e.message),1)],64))],42,W),a.contextMenu.visible&&a.contextMenu.messageId===e.id?((0,o.uX)(),(0,o.CE)("div",{key:1,style:(0,u.Tr)({left:a.contextMenu.x+"px",top:a.contextMenu.y+"px"}),class:"message-context-menu"},[(0,o.Lk)("div",{onClick:s=>i.startEditing(e)},"Редактировать",8,Y),(0,o.Lk)("div",{onClick:s=>i.deleteMessage(e.id)},"Удалить",8,Z)],4)):(0,o.Q3)("",!0)])))),128)):((0,o.uX)(),(0,o.CE)("div",K," Пожалуйста, выберите собеседника, чтобы начать чат. "))],512),(0,o.Lk)("div",q,[(0,o.Lk)("div",G,[(0,o.bo)((0,o.Lk)("input",{"onUpdate:modelValue":s[5]||(s[5]=e=>a.message=e),type:"text",placeholder:"Type your message...",class:"message-input",onKeyup:s[6]||(s[6]=(0,r.jR)(((...e)=>i.sendMessage&&i.sendMessage(...e)),["enter"])),disabled:!a.selectedUser},null,40,ee),[[r.Jo,a.message]]),(0,o.Lk)("button",{class:"send-button",onClick:s[7]||(s[7]=(...e)=>i.sendMessage&&i.sendMessage(...e)),disabled:!a.selectedUser},null,8,se)])])])])}t(8111),t(2489);var re=t(1714),oe={name:"ChatPage",data(){return{socket:null,message:"",messages:[],token:localStorage.getItem("chatToken")||"",userId:localStorage.getItem("chatUserId")||null,nickname:localStorage.getItem("chatNickname")||"",users:[],selectedUser:null,editingMessageId:null,editingMessageText:"",contextMenu:{visible:!1,messageId:null,x:0,y:0}}},directives:{focus:{mounted(e){e.focus()}}},created(){if(!this.token||!this.userId)return console.warn("Токен или ID пользователя отсутствуют. Перенаправление на страницу входа."),void this.$router.push("/log");this.connectSocket(),this.fetchUsers(),document.addEventListener("click",this.closeContextMenu)},beforeUnmount(){this.socket&&this.socket.disconnect(),document.removeEventListener("click",this.closeContextMenu)},watch:{selectedUser(e,s){e&&e.id!==(s?s.id:null)&&(this.fetchMessages(e.id),this.editingMessageId=null,this.contextMenu.visible=!1)}},methods:{connectSocket(){this.socket=(0,re.io)("http://192.168.100.2:3000"),this.socket.on("connect",(()=>{console.log("Socket connected:",this.socket.id),this.token&&this.socket.emit("authenticate",this.token)})),this.socket.on("authenticated",(e=>{console.log("Socket authenticated for user:",e.nickname),this.userId=e.userId,this.nickname=e.nickname})),this.socket.on("authentication_error",(e=>{console.error("Socket authentication error:",e.message),localStorage.removeItem("chatToken"),localStorage.removeItem("chatUserId"),localStorage.removeItem("chatNickname"),alert("Ошибка аутентификации. Пожалуйста, войдите снова."),this.$router.push("/log")})),this.socket.on("receive_message",(e=>{console.log("Получено сообщение:",e),(e.sender_id===this.userId&&e.receiver_id===this.selectedUser?.id||e.sender_id===this.selectedUser?.id&&e.receiver_id===this.userId)&&(this.messages.push(e),this.$nextTick((()=>{this.scrollToBottom()})))})),this.socket.on("message_error",(e=>{console.error("Message error:",e.message),alert(`Ошибка сообщения: ${e.message}`)})),this.socket.on("disconnect",(()=>{console.log("Socket disconnected")})),this.socket.on("message_updated",(e=>{console.log("Сообщение обновлено через Socket.IO:",e);const s=this.messages.findIndex((s=>s.id===e.id));-1!==s&&(e.sender_id===this.userId&&e.receiver_id===this.selectedUser?.id||e.sender_id===this.selectedUser?.id&&e.receiver_id===this.userId)&&(this.messages.splice(s,1,e),this.$nextTick((()=>{this.scrollToBottom()})))})),this.socket.on("message_deleted",(({messageId:e,senderId:s,receiverId:t})=>{console.log("Сообщение удалено через Socket.IO:",e),(s===this.userId&&t===this.selectedUser?.id||s===this.selectedUser?.id&&t===this.userId)&&(this.messages=this.messages.filter((s=>s.id!==e)),this.$nextTick((()=>{this.scrollToBottom()})))}))},async fetchUsers(){try{const e=await fetch("http://192.168.100.2:3000/api/users",{headers:{Authorization:`Bearer ${this.token}`}});if(e.ok){let s=await e.json();this.users=s.filter((e=>e.id!==this.userId)),this.users.length>0&&!this.selectedUser&&this.selectUser(this.users[0])}else 401===e.status?(console.error("Неавторизованный доступ к пользователям. Перенаправление на вход."),localStorage.removeItem("chatToken"),localStorage.removeItem("chatUserId"),localStorage.removeItem("chatNickname"),this.$router.push("/log")):console.error("Failed to fetch users:",e.statusText)}catch(e){console.error("Error fetching users:",e)}},async fetchMessages(e){if(e)try{const s=await fetch(`http://192.168.100.2:3000/api/messages/${e}`,{headers:{Authorization:`Bearer ${this.token}`}});s.ok?(this.messages=await s.json(),this.$nextTick((()=>{this.scrollToBottom()}))):401===s.status?(console.error("Неавторизованный доступ к сообщениям. Перенаправление на вход."),localStorage.removeItem("chatToken"),localStorage.removeItem("chatUserId"),localStorage.removeItem("chatNickname"),this.$router.push("/log")):(console.error("Failed to fetch messages:",s.statusText),this.messages=[])}catch(s){console.error("Error fetching messages:",s),this.messages=[]}},sendMessage(){""!==this.message.trim()&&this.socket&&this.selectedUser&&(this.socket.emit("send_message",{receiverId:this.selectedUser.id,message:this.message.trim()}),this.message="")},selectUser(e){this.selectedUser=e,this.messages=[]},showContextMenu(e,s){e.sender_id===this.userId&&(this.contextMenu.messageId=e.id,this.contextMenu.x=s.clientX,this.contextMenu.y=s.clientY,this.contextMenu.visible=!0,s.stopPropagation())},closeContextMenu(){this.contextMenu.visible=!1,this.contextMenu.messageId=null},startEditing(e){this.editingMessageId=e.id,this.editingMessageText=e.message,this.closeContextMenu()},async saveEditedMessage(){if(""!==this.editingMessageText.trim())if(this.editingMessageId)try{const e=await fetch(`http://192.168.100.2:3000/api/messages/${this.editingMessageId}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({newMessageText:this.editingMessageText})});if(e.ok)console.log("Сообщение успешно отредактировано на сервере.");else{const s=await e.json();console.error("Ошибка при редактировании сообщения:",s.message),alert(`Ошибка: ${s.message}`)}}catch(e){console.error("Network error during message edit:",e),alert("Не удалось подключиться к серверу для редактирования сообщения.")}finally{this.cancelEditing()}else console.error("Не выбран ID сообщения для редактирования.");else alert("Сообщение не может быть пустым.")},cancelEditing(){this.editingMessageId=null,this.editingMessageText=""},async deleteMessage(e){if(confirm("Вы уверены, что хотите удалить это сообщение?"))if(e)try{const s=await fetch(`http://192.168.100.2:3000/api/messages/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${this.token}`}});if(s.ok)console.log("Сообщение успешно удалено на сервере.");else{const e=await s.json();console.error("Ошибка при удалении сообщения:",e.message),alert(`Ошибка: ${e.message}`)}}catch(s){console.error("Network error during message delete:",s),alert("Не удалось подключиться к серверу для удаления сообщения.")}finally{this.closeContextMenu()}else console.error("Не выбран ID сообщения для удаления.")},shouldShowTimestamp(e,s){if(!s)return!0;const t=new Date(e),r=new Date(s);if(t.toDateString()!==r.toDateString())return!0;const o=Math.abs(t.getTime()-r.getTime())/6e4;return o>=2||t.getHours()!==r.getHours()},formatTimestamp(e){const s=new Date,t=new Date(e),r=s.toDateString()===t.toDateString();if(r)return t.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"});{const e={day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"};return t.toLocaleDateString("ru-RU",e).replace(/\./g,"").replace(",","").trim()}},scrollToBottom(){const e=this.$refs.messagesContainer;e&&(e.scrollTop=e.scrollHeight)}}};const ne=(0,i.A)(oe,[["render",te],["__scopeId","data-v-398220a9"]]);var ae=ne;const ie=[{path:"/",name:"reg",component:b},{path:"/log",name:"login",component:O},{path:"/chat",name:"chat",component:ae}],ce=(0,d.aE)({history:(0,d.Bt)(),routes:ie});var le=ce;(0,r.Ef)(l).use(le).mount("#app")}},s={};function t(r){var o=s[r];if(void 0!==o)return o.exports;var n=s[r]={exports:{}};return e[r].call(n.exports,n,n.exports,t),n.exports}t.m=e,function(){var e=[];t.O=function(s,r,o,n){if(!r){var a=1/0;for(d=0;d<e.length;d++){r=e[d][0],o=e[d][1],n=e[d][2];for(var i=!0,c=0;c<r.length;c++)(!1&n||a>=n)&&Object.keys(t.O).every((function(e){return t.O[e](r[c])}))?r.splice(c--,1):(i=!1,n<a&&(a=n));if(i){e.splice(d--,1);var l=o();void 0!==l&&(s=l)}}return s}n=n||0;for(var d=e.length;d>0&&e[d-1][2]>n;d--)e[d]=e[d-1];e[d]=[r,o,n]}}(),function(){t.n=function(e){var s=e&&e.__esModule?function(){return e["default"]}:function(){return e};return t.d(s,{a:s}),s}}(),function(){t.d=function(e,s){for(var r in s)t.o(s,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:s[r]})}}(),function(){t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){t.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)}}(),function(){t.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};t.O.j=function(s){return 0===e[s]};var s=function(s,r){var o,n,a=r[0],i=r[1],c=r[2],l=0;if(a.some((function(s){return 0!==e[s]}))){for(o in i)t.o(i,o)&&(t.m[o]=i[o]);if(c)var d=c(t)}for(s&&s(r);l<a.length;l++)n=a[l],t.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return t.O(d)},r=self["webpackChunkapp"]=self["webpackChunkapp"]||[];r.forEach(s.bind(null,0)),r.push=s.bind(null,r.push.bind(r))}();var r=t.O(void 0,[504],(function(){return t(7814)}));r=t.O(r)})();
//# sourceMappingURL=app.3f2c5c2e.js.map